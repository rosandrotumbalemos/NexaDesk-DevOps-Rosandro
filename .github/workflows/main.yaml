name: NexaDesk DevOps Pipeline

on:
  push:
    branches: [ "main" ] # Dispara quando você envia código

jobs:
  # TRILHA 1: INTEGRAÇÃO CONTÍNUA (CI)
  test-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Baixar Código (Checkout)
        uses: actions/checkout@v3

      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Executar Testes Automatizados
        run: |
          cd src
          npm test
        # Se o teste falhar aqui, o processo para imediatamente.

      - name: Construir Imagem Docker
        run: |
          docker build -t nexadesk-api:${{ github.sha }} .
          echo "Imagem Docker construída com sucesso!"

  # TRILHA 2: ENTREGA CONTÍNUA (CD)
  deploy-simulation:
    needs: test-and-build # Só roda se a etapa anterior passar
    runs-on: ubuntu-latest
    steps:
      - name: Simular Deploy no Kubernetes
        run: |
          echo "Conectando ao Cluster Kubernetes..."
          echo "Aplicando arquivo k8s/deployment.yaml..."
          echo "Status: SUCESSO - Aplicação atualizada para versão ${{ github.sha }}"